@page "/"
@using Ava.Data
@using Ava.Data.Statistics
@using Ava.Interfaces
@using Ava.Services
@using Microsoft.AspNetCore.Identity
@inherits Ava.Components.Bases.LayoutBase
@inject IGameStatsService GameStatsService
@inject UserManager<ApplicationUser> UserManager
<PageTitle>Home</PageTitle>

<div class="w-4/5 mx-auto grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
    <div class="lg:col-span-3">
        @* <img src="images/hero/heroes-home.png" class="rounded mb-4" /> *@
        @if (CurrentUser != null)
        {
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div class="flex justify-center items-center w-full">
                    <div class="p-4 w-full bg-gray-800 dark:bg-white rounded-lg shadow-md text-center">
                        <div class="flex justify-center items-center mb-4">
                            <div class="text-white dark:text-primary">
                                <svg class="w-6 h-6" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                                    <path fill-rule="evenodd" d="M8.6 5.2A1 1 0 0 0 7 6v12a1 1 0 0 0 1.6.8l8-6a1 1 0 0 0 0-1.6l-8-6Z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-6 text-lg font-semibold text-white dark:text-gray-900">
                                Games
                            </div>
                        </div>
                        <div class="mt-2 text-5xl font-extrabold text-white dark:text-primary">
                            @totalGamesPlayed
                        </div>
                    </div>
                </div>
                <div class="flex justify-center items-center w-full">
                    <div class="p-4 w-full bg-gray-800 dark:bg-white rounded-lg shadow-md text-center">
                        <div class="flex justify-center items-center mb-4">
                            <div class="text-white dark:text-primary">
                                <svg class="w-6 h-6" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m7.171 12.906-2.153 6.411 2.672-.89 1.568 2.34 1.825-5.183m5.73-2.678 2.154 6.411-2.673-.89-1.568 2.34-1.825-5.183M9.165 4.3c.58.068 1.153-.17 1.515-.628a1.681 1.681 0 0 1 2.64 0 1.68 1.68 0 0 0 1.515.628 1.681 1.681 0 0 1 1.866 1.866c-.068.58.17 1.154.628 1.516a1.681 1.681 0 0 1 0 2.639 1.682 1.682 0 0 0-.628 1.515 1.681 1.681 0 0 1-1.866 1.866 1.681 1.681 0 0 0-1.516.628 1.681 1.681 0 0 1-2.639 0 1.681 1.681 0 0 0-1.515-.628 1.681 1.681 0 0 1-1.867-1.866 1.681 1.681 0 0 0-.627-1.515 1.681 1.681 0 0 1 0-2.64c.458-.361.696-.935.627-1.515A1.681 1.681 0 0 1 9.165 4.3ZM14 9a2 2 0 1 1-4 0 2 2 0 0 1 4 0Z" />
                                </svg>
                            </div>
                            <div class="ml-6 text-lg font-semibold text-white dark:text-gray-900">
                                Wins
                            </div>
                        </div>
                        <div class="mt-2 text-5xl font-extrabold text-white dark:text-primary">
                            @totalWins
                        </div>
                    </div>
                </div>
                <div class="flex justify-center items-center w-full">
                    <div class="p-4 w-full bg-gray-800 dark:bg-white rounded-lg shadow-md text-center">
                        <div class="flex justify-center items-center mb-4">
                            <div class="text-white dark:text-primary">
                                <svg class="w-6 h-6" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                                    <path fill-rule="evenodd" d="M8.586 2.586A2 2 0 0 1 10 2h4a2 2 0 0 1 2 2v2h3a1 1 0 1 1 0 2v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V8a1 1 0 0 1 0-2h3V4a2 2 0 0 1 .586-1.414ZM10 6h4V4h-4v2Zm1 4a1 1 0 1 0-2 0v8a1 1 0 1 0 2 0v-8Zm4 0a1 1 0 1 0-2 0v8a1 1 0 1 0 2 0v-8Z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-6 text-lg font-semibold text-white dark:text-gray-900">
                                Losses
                            </div>
                        </div>
                        <div class="mt-2 text-5xl font-extrabold text-white dark:text-primary">
                            @totalLosses
                        </div>
                    </div>
                </div>
                <div class="flex justify-center items-center w-full">
                    <div class="p-4 w-full bg-gray-800 dark:bg-white rounded-lg shadow-md text-center">
                        <div class="flex justify-center items-center mb-4">
                            <div class="text-white dark:text-primary">
                                <svg class="w-6 h-6" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                                    <path fill-rule="evenodd" d="M20.29 8.567c.133.323.334.613.59.85v.002a3.536 3.536 0 0 1 0 5.166 2.442 2.442 0 0 0-.776 1.868 3.534 3.534 0 0 1-3.651 3.653 2.483 2.483 0 0 0-1.87.776 3.537 3.537 0 0 1-5.164 0 2.44 2.44 0 0 0-1.87-.776 3.533 3.533 0 0 1-3.653-3.654 2.44 2.44 0 0 0-.775-1.868 3.537 3.537 0 0 1 0-5.166 2.44 2.44 0 0 0 .775-1.87 3.55 3.55 0 0 1 1.033-2.62 3.594 3.594 0 0 1 2.62-1.032 2.401 2.401 0 0 0 1.87-.775 3.535 3.535 0 0 1 5.165 0 2.444 2.444 0 0 0 1.869.775 3.532 3.532 0 0 1 3.652 3.652c-.012.35.051.697.184 1.02ZM9.927 7.371a1 1 0 1 0 0 2h.01a1 1 0 0 0 0-2h-.01Zm5.889 2.226a1 1 0 0 0-1.414-1.415L8.184 14.4a1 1 0 0 0 1.414 1.414l6.218-6.217Zm-2.79 5.028a1 1 0 1 0 0 2h.01a1 1 0 1 0 0-2h-.01Z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-6 text-lg font-semibold text-white dark:text-gray-900">
                                Win %
                            </div>
                        </div>
                        <div class="mt-2 text-5xl font-extrabold text-white dark:text-primary">
                            @winPercentage
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="flex justify-center items-center w-full">
                    <a href="User/@mostFrequentOpponent?.Opponent.Id" class="flex flex-col items-center bg-blue-500 dark:bg-blue-700 border border-gray-200 rounded-lg shadow md:flex-row md:max-w-xl hover:bg-blue-700 hover:text-white dark:border-gray-700 dark:bg-gray-800 dark:hover:bg-primary dark:text-white h-full">
                        <img class="object-cover w-full rounded-t-lg lg:h-auto md:h-auto md:w-48 md:rounded-none md:rounded-l-lg" src="images/avatars/@mostFrequentOpponent?.Opponent.ProfilePictureUrl" alt="@mostFrequentOpponent?.Opponent.DisplayName">
                        <div class="flex flex-col justify-between p-4 leading-normal h-full">
                            <div class="mb-2 tracking-tight text-white dark:text-white truncate">@mostFrequentOpponent?.Opponent.DisplayName</div>
                            <div class="mb-3 font-normal text-white dark:text-gray-400 text-md">@mostFrequentOpponent?.Wins (W) | @mostFrequentOpponent?.Losses (L)</div>
                            <div class="text-white text-lg">@mostFrequentOpponent?.Percentage%</div>
                            <div class="text-white dark:text-primary text-sm">@TimeHelper.GetLastPlayedText(mostFrequentOpponent?.LastPlayed)</div>
                        </div>
                    </a>
                </div>
                <div class="flex justify-center items-center w-full">
                    <a href="User/@mostDifficultOpponent?.Opponent.Id" class="flex flex-col items-center bg-red-500 dark:bg-red-700 border border-gray-200 rounded-lg shadow md:flex-row md:max-w-xl hover:bg-red-700 hover:text-white dark:border-gray-700 dark:bg-gray-800 dark:hover:bg-primary dark:text-white h-full">
                        <img class="object-cover w-full rounded-t-lg lg:h-auto md:h-auto md:w-48 md:rounded-none md:rounded-l-lg" src="images/avatars/@mostDifficultOpponent?.Opponent.ProfilePictureUrl" alt="@mostDifficultOpponent?.Opponent.DisplayName">
                        <div class="flex flex-col justify-between p-4 leading-normal h-full">
                            <div class="mb-2 tracking-tight text-white dark:text-white truncate">@mostDifficultOpponent?.Opponent.DisplayName</div>
                            <div class="mb-3 font-normal text-white dark:text-gray-400">@mostDifficultOpponent?.Wins (W) | @mostDifficultOpponent?.Losses (L)</div>
                            <div class="text-white text-lg">@mostDifficultOpponent?.Percentage%</div>
                            <div class="text-white dark:text-primary text-sm">@TimeHelper.GetLastPlayedText(mostDifficultOpponent?.LastPlayed)</div>
                        </div>
                    </a>
                </div>
                <div class="flex justify-center items-center w-full">
                    <a href="User/@mostEasiestOpponent?.Opponent.Id" class="flex flex-col items-center bg-green-500 dark:bg-green-700 border border-gray-200 rounded-lg shadow md:flex-row md:max-w-xl hover:bg-green-700 hover:text-white dark:border-gray-700 dark:bg-gray-800 dark:hover:bg-primary dark:text-white h-full">
                        <img class="object-cover w-full rounded-t-lg lg:h-auto md:h-auto md:w-48 md:rounded-none md:rounded-l-lg" src="images/avatars/@mostEasiestOpponent?.Opponent.ProfilePictureUrl" alt="@mostEasiestOpponent?.Opponent.DisplayName">
                        <div class="flex flex-col justify-between p-4 leading-normal h-full">
                            <div class="mb-2 tracking-tight text-white dark:text-white truncate">@mostEasiestOpponent?.Opponent.DisplayName</div>
                            <div class="mb-3 font-normal text-white dark:text-gray-400">@mostEasiestOpponent?.Wins (W) | @mostEasiestOpponent?.Losses (L)</div>
                            <div class="text-white text-lg">@mostEasiestOpponent?.Percentage%</div>
                            <div class="text-white dark:text-primary text-sm">@TimeHelper.GetLastPlayedText(mostEasiestOpponent?.LastPlayed)</div>
                        </div>
                    </a>
                </div>
            </div>
        }
    </div>
    <div>
        <FriendsList />
    </div>
</div>

@code {
    private int totalGamesPlayed = 0;
    private int totalWins = 0;
    private int totalLosses = 0;
    private double winPercentage = 0.0;
    private OpponentStats mostFrequentOpponent;
    private OpponentStats mostEasiestOpponent;
    private OpponentStats mostDifficultOpponent;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        if (CurrentUser != null)
        {
            await LoadUserStatsAsync(CurrentUser.Id);
        }
    }

    private async Task LoadUserStatsAsync(string userId)
    {
        totalGamesPlayed = await GameStatsService.GetTotalGamesPlayedAsync(userId);
        totalWins = await GameStatsService.GetTotalWinsAsync(userId);
        totalLosses = await GameStatsService.GetTotalLossesAsync(userId);

        // Calculate the win percentage
        if (totalGamesPlayed > 0)
        {
            winPercentage = Math.Round((double)totalWins / totalGamesPlayed * 100, 2);
        }

        mostFrequentOpponent = await GameStatsService.GetMostFrequentOpponentAsync(userId);
        mostEasiestOpponent = await GameStatsService.GetEasiestOpponentAsync(userId);
        mostDifficultOpponent = await GameStatsService.GetMostDifficultOpponentAsync(userId);
    }
}
